<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Antibody Plot Browser</title>
  <style>
    :root{--bg:#0b1020;--card:#111833;--muted:#cbd5e1;--accent:#8ab4ff;--text:#e2e8f0}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1020,#0e1430);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:24px;margin:0 0 8px}
    .sub{color:var(--muted);margin-bottom:20px}
    .panel{background:var(--card);border:1px solid #233057;border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.35)}
    .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    label{display:flex;flex-direction:column;font-size:12px;color:var(--muted);gap:6px}
    select{appearance:none;background:#0d1328;border:1px solid #233057;border-radius:10px;color:var(--text);padding:10px 12px}
    .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-top:12px}
    button, .linklike{background:#14224a;border:1px solid #2a3a70;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    button:hover,.linklike:hover{filter:brightness(1.1)}
    .imgWrap{margin-top:18px;background:#0b122a;border:1px solid #1e2a52;border-radius:16px;padding:12px;display:flex;justify-content:center;align-items:center;min-height:360px}
    img{max-width:100%;height:auto;border-radius:12px}
    .note{color:var(--muted);font-size:12px;margin-top:6px}
    .error{color:#ffb4b4}
    footer{margin-top:28px;color:var(--muted);font-size:12px}
    code{background:#0b122a;border:1px solid #1e2a52;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Antibody Plot Browser</h1>
    <div class="sub">Browse pre-rendered two-by-two plots without exposing raw data.</div>

    <div class="panel">
      <div class="grid" role="group" aria-label="Plot controls">
        <label>Family
          <select id="family">
            <option value="flavi">Flaviviruses</option>
            <option value="alpha">Alphaviruses</option>
          </select>
        </label>
        <label>Sex
          <select id="sex">
            <option value="Both">Both</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
          </select>
        </label>
        <label>Site
          <select id="site">
            <option value="All">All</option>
            <option value="Peru">Peru</option>
            <option value="Senegal">Senegal</option>
            <option value="French Guiana">French Guiana</option>
            <option value="New Caledonia">New Caledonia</option>
          </select>
        </label>
        <label>X antigen
          <select id="x"></select>
        </label>
        <label>Y antigen
          <select id="y"></select>
        </label>
        
      </div>

      <div class="row">
        <button id="swap" title="Swap X and Y">Swap X/Y</button>
        <button id="copy" title="Copy a shareable link">Copy share link</button>
        <span id="status" class="note" aria-live="polite"></span>
      </div>

      <div class="imgWrap" aria-live="polite">
        <img id="plot" alt="Antibody scatterplot" />
      </div>
      <div class="note">If a plot is missing, you'll see a fallback image.
        File path pattern: <code>plots/{family}/{sex}/{site}/{x}__vs__{y}.png</code>
      </div>
    </div>

    <footer>
      Host the images under <code>plots/...</code> in your GitHub Pages repo.
      Edit antigen lists in this file. No data or JSON is ever sent—only image URLs are referenced.
    </footer>
  </div>

  <script>
    // =====================
    //  CONFIGURATION
    // =====================
    // 1) Update this to your GitHub Pages base. Example:
    // const BASE = "https://yourname.github.io/your-repo/plots";
    // If the site root serves plots/, you can keep it relative:
    const BASE = "plots"; // folder at repo root

    // 2) Antigen lists (edit to your canonical names). These must match filenames.
    const ANTIGENS = {
      flavi: [
        "DENV1 VLP","DENV2 VLP","DENV3 VLP","DENV4 VLP",
        "DENV1 NS1","DENV2 NS1","DENV3 NS1","DENV4 NS1",
        "DENV1 EDIII","DENV2 EDIII","DENV3 EDIII","DENV4 EDIII",
        "ZIKV VLP","ZIKVU NS1","ZIKVSU NS1","ZIKVAS EDIII",
        "YFV E","YFV NS1","JEV E","JEV NS1","WNV NS1","WNV EDIII","USUV NS1"
      ],
      alpha: [
        "CHIKV VLP","CHIKV E2","ONNV VLP","MAYV E2","MAYV NSP1"
      ]
    };

    // 3) Optional: Placeholder image when a specific plot is missing
    const FALLBACK = "assets/missing.png"; // put a small PNG under /assets // put a small PNG under /assets

    // =====================
    //  RUNTIME LOGIC
    // =====================
    const els = {
      family: document.getElementById('family'),
      sex: document.getElementById('sex'),
      site: document.getElementById('site'),
      x: document.getElementById('x'),
      y: document.getElementById('y'),      img: document.getElementById('plot'),
      swap: document.getElementById('swap'),
      copy: document.getElementById('copy'),
      status: document.getElementById('status')
    };

    function populateXY() {
      const list = ANTIGENS[els.family.value] || [];
      function setOptions(sel) {
        sel.innerHTML = '';
        for (const name of list) {
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name; sel.appendChild(opt);
        }
      }
      setOptions(els.x); setOptions(els.y);
      // Choose first two distinct by default
      if (list.length > 1) { els.y.value = list[1]; }
    }

    function buildUrl() {
      const { family, sex, site, x, y } = Object.fromEntries(
        ['family','sex','site','x','y'].map(id => [id, els[id].value])
      );
      const safe = s => s.replace(/[^A-Za-z0-9._-]+/g, '_');
      const segs = [family, sex, site, `${safe(x)}__vs__${safe(y)}.png`].map(encodeURIComponent);
      return `${BASE}/${segs.join('/')}`;
    } = Object.fromEntries(
        ['family','sex','site','x','y'].map(id => [id, els[id].value])
      );
      // Filename convention: {x}__vs__{y}.png — ensure your generator matches this
      const path = `${family}/${sex}/${site}/${x}__vs__${y}.png`;
      return `${BASE}/${path}`;
    }

    function updateImg() {
      const url = buildUrl();
      els.img.src = url;
      els.img.alt = `${els.x.value} vs ${els.y.value} (${els.sex.value}, ${els.site.value}, ${els.family.options[els.family.selectedIndex].text})`;
      // update URL hash so the current selection is shareable
      const state = new URLSearchParams({
        f: els.family.value, s: els.sex.value, t: els.site.value, x: els.x.value, y: els.y.value
      });
      history.replaceState(null, '', `#${state.toString()}`);
      // speculative preload to make swaps feel instant
      preloadNeighbors();
    }

    function preloadNeighbors(){
      const safe = s => s.replace(/[^A-Za-z0-9._-]+/g, '_');
      const enc = s => encodeURIComponent(s);
      const variants = [];
      // swapped
      variants.push(`${BASE}/${enc(els.family.value)}/${enc(els.sex.value)}/${enc(els.site.value)}/${enc(safe(els.y.value))}__vs__${enc(safe(els.x.value))}.png`);
      // other sexes
      for (const altSex of ['Both','Male','Female']){
        if (altSex!==els.sex.value) variants.push(`${BASE}/${enc(els.family.value)}/${enc(altSex)}/${enc(els.site.value)}/${enc(safe(els.x.value))}__vs__${enc(safe(els.y.value))}.png`);
      }
      // other sites
      for (const altSite of Array.from(els.site.options, o=>o.value)){
        if (altSite!==els.site.value) variants.push(`${BASE}/${enc(els.family.value)}/${enc(els.sex.value)}/${enc(altSite)}/${enc(safe(els.x.value))}__vs__${enc(safe(els.y.value))}.png`);
      }
      for (const src of variants){ const img = new Image(); img.decoding='async'; img.src = src; }
    }/${els.family.value}/${els.sex.value}/${els.site.value}/${els.y.value}__vs__${els.x.value}.png`);
      for (const altSex of ['Both','Male','Female']){
        if (altSex!==els.sex.value) variants.push(`${BASE}/${els.family.value}/${altSex}/${els.site.value}/${els.x.value}__vs__${els.y.value}.png`);
      }
      for (const altSite of Array.from(els.site.options, o=>o.value)){
        if (altSite!==els.site.value) variants.push(`${BASE}/${els.family.value}/${els.sex.value}/${altSite}/${els.x.value}__vs__${els.y.value}.png`);
      }
      for (const src of variants){ const img = new Image(); img.decoding='async'; img.src = src; }
    }

    // Error fallback if a file is missing
    els.img.addEventListener('error', ()=>{
      // Try an alternate sex folder name if the file is missing (Both ↔ All)
      const tried = els.img.getAttribute('data-tried-alt-sex') === '1';
      const sexVal = els.sex.value;
      const alt = sexVal === 'Both' ? 'All' : (sexVal === 'All' ? 'Both' : null);
      if (!tried && alt){
        els.img.setAttribute('data-tried-alt-sex','1');
        const url = buildUrl().replace(`/${sexVal}/`, `/${alt}/`);
        els.img.src = url;
        els.status.textContent = `Plot not found for “${sexVal}”; trying “${alt}”.`;
        return;
      }
      els.img.removeAttribute('data-tried-alt-sex');
      if (FALLBACK) { els.img.src = FALLBACK; els.status.textContent = 'Plot not found. Showing placeholder.'; els.status.classList.add('error'); }
    }); }
    });

    // Restore state from URL hash if present
    function restoreFromHash(){
      const hash = location.hash.replace(/^#/, '');
      if (!hash) return;
      const p = new URLSearchParams(hash);
      if (p.get('f')) els.family.value = p.get('f');
      populateXY();
      if (p.get('x')) els.x.value = p.get('x');
      if (p.get('y')) els.y.value = p.get('y');
      if (p.get('s')) els.sex.value = p.get('s');
      if (p.get('t')) els.site.value = p.get('t');
    }

    // Events
    els.family.addEventListener('change', ()=>{ populateXY(); updateImg(); });
    for (const id of ['sex','site','x','y']){
      els[id].addEventListener('change', updateImg);
    }
    els.swap.addEventListener('click', ()=>{
      const xv = els.x.value; els.x.value = els.y.value; els.y.value = xv; updateImg();
    });
    els.copy.addEventListener('click', async ()=>{
      const url = location.href;
      try { await navigator.clipboard.writeText(url); els.status.textContent = 'Link copied to clipboard.'; }
      catch(e){ els.status.textContent = 'Copy failed. Select and copy the address bar.'; }
      setTimeout(()=> els.status.textContent = '', 2500);
    });

    // Init
    populateXY();
    restoreFromHash();
    updateImg();
  </script>
</body>
</html>
